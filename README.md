URL shortener
======

RESTful API для сокращателя ссылок

Стек: python(Flask) + PostgreSQL + ngnix

Установка
-----

Перед тем, как приступить к запуску, убедитесь, что у вас установлены **docker** и **docker-compose**

Для того, чтобы развернуть приложение, в корневой директории проекта выполните:

    docker-compose up -d

*При первом запуске, сборка может занять длительное время*

После сборки, приложение будет запущено локально: <http://0.0.0.0:8080>


Описание
------
#### Авторизация
Для авторизации исользуется HTTP Basic Authorization
Запросы к сервису осуществляются посредством методов GET (+ GET-параметры) и  POST, DELETE (+ JSON)
Сервис возвращает данные в формате JSON

Ресурсы и методы API
------

#### /api/v1/users 
**Ресурс**, предоставляющий работу с пользователями.
- POST /api/v1/users - регистрация пользователя (авторизация не требуется).
    
    Пример ответа сервера, при успешном выполнении запроса:
        
        {
            "message": "User successfully registered"
        }
    
- GET  /api/v1/users/me - получение информации о текущем авторизованном пользователе.
    
    Пример ответа сервера, при успешном выполнении запроса:
        
        {
            "data": {
                "id": 1,
                "login": "admin",
                "links_created": 2
            }
        }


#### /api/v1/users/me/shorten_urls
**Ресурс**, предоставляющий работу с короткими ссылками пользователя
- POST /api/v1/users/me/shorten_urls - создание новой короткой ссылки. Возвращает созданную ссылку.
    
    Пример ответа сервера, при успешном выполнении запроса:
        
         {
            "data": {
                "id": 3,
                "url": "http://google.com",
                "short_url": "http://localhost:8080/api/v1/shorten_urls/6506076198b0"
            }
        }

- GET /api/v1/users/me/shorten_urls - получение всех созданных коротких ссылок пользователя

    Пример ответа сервера, при успешном выполнении запроса:
        
         {
            "data": [
                {
                    "id": 1,
                    "url": "http://vk.com",
                    "shortLink": "http://localhost:8080/api/v1/shorten_urls/0b888ec03aed"
                },
                {
                    "id": 2,
                    "url": "http://vk.ru",
                    "shortLink": "http://localhost:8080/api/v1/shorten_urls/897c0286e8ae"
                },
                {
                    "id": 3,
                    "url": "http://google.com",
                    "shortLink": "http://localhost:8080/api/v1/shorten_urls/6506076198b0"
                }
            ]
        }

- GET /api/v1/users/me/shorten_urls/{id} - получение полной информации о конкретной короткой ссылке пользователя

    Пример ответа сервера при успешном выполнении запроса:

        {
            "data": {
                "id": 1,
                "url": "http://vk.com",
                "short_url": "http://localhost:8080/api/v1/shorten_urls/0b888ec03aed",
                "count_of_redirects": 7,
                "created": "14.11.2017 15:10"
            }
        }

- DELETE /api/v1/users/me/shorten_urls/{id}- удаление короткой ссылки пользователя

    Пример ответа сервера при успешном выполнении запроса:
    
        {
            "message": "Link was successfully deleted"
        }

**Отчеты**

- GET /api/v1/users/me/shorten_urls/{id}/[days,hours,min]?from_date=yyyy-mm-dd&to_date=yyyy-mm-dd - получение временного графика количества переходов с группировкой по дням, часам, минутам.

    Полученный ответ представляет собой массив точек с координатами {*x*:*y*}, где *x* - время, *y* - количество переходов
    
    Пример ответа сервера при успешном выполнении запроса:
    
       {
            "data": {
                "14.11.2017 00:00": 7,
                "14.11.2017 01:00": 0,
                "14.11.2017 02:00": 0,
                "14.11.2017 03:00": 0,
                "14.11.2017 04:00": 0,
                "14.11.2017 05:00": 2,
                "14.11.2017 06:00": 0,
                "14.11.2017 07:00": 0,
                "14.11.2017 08:00": 1,
                "14.11.2017 09:00": 0,
                "14.11.2017 10:00": 5,
                "14.11.2017 11:00": 0,
                "14.11.2017 12:00": 3,
                "14.11.2017 13:00": 0,
                "14.11.2017 14:00": 0,
                "14.11.2017 15:00": 5,
                "14.11.2017 16:00": 2,
                "14.11.2017 17:00": 0,
                "14.11.2017 18:00": 0,
                "14.11.2017 19:00": 11,
                "14.11.2017 20:00": 9,
                "14.11.2017 21:00": 0,
                "14.11.2017 22:00": 0
            }
        }

- GET /api/v1/users/me/shorten_urls/{id}/referers - получение топа из 20 сайтов - иcточников переходов*
    
    *-источник перехода (HTTP referrer) - один из заголовков HTTP запроса, который содержит информацию о сайте, с которого пользователь перешел по ссылке.
В некоторых случаях не может быть определен, и сокращатель ссылок записывает в базу переход со значением поля *referrer* = None.

    Переходы  с источником "None" можно исключить из отчета, присвоив переменной **INCLUDE_NONE_REFERRER_IN_REF_REPORT** в config.py значение **False**
  
    Пример ответа сервера при успешном выполнении запроса: 
  
        {
            "data": [
                {
                    "referrer": "None",
                    "count_of_redirects": 7
                },
                {
                    "referrer": "http://vk.com",
                    "count_of_redirects": 2
                }
            ]
        }
    

#### /api/v1/shorten_urls
Ресурс, предоставляющий работу с короткими ссылками (авторизация не требуется)
GET /api/v1/shorten_urls/{hash} - переход по ссылке (302 rediret)

Ошибки при запросах к API
------
Обо всех ошибках, возникающих во время обработки запроса, сервис сообщает в свойстве "error" JSON-объекта, с соответствующим HTTP-статусом.

Пример ответа сервиса при ошибочном запросе:

        {
            "error": "The link is not valid"
        }
Сообщения об ошибках можно изменить в `/api/v1/messages.py`

Примеры работы с сервисом, при помощи curl
-----
- Авторизация пользователя, используя заголовок "Authorization":

   добавить к запросу `-H "Authorization: token_str"`, где *token_str* - закодированная в base64 строка "user:password"
   
- Авторизация пользователя, используя ключ `-u`:

    Добавить к запросу `-u user:password`
    
- Добаить нового пользователя:

         curl http://localhost:8080/api/v1/users -i -H "Content-Type: application/json" -X POST -d '{"login":"your_login","password":"your_password"}'
        
- Добавить новую короткую ссылку:

        curl http://localhost:8080/api/v1/users/me/shorten_urls -i -H "Content-Type: application/json" -X POST -d '{"url":"http://google.com"}' -u user:password
    
- Получить отчет о переходах по ссылке с id = 4, с группировкой по часам за 14.11.2017

        curl http://localhost:8080/api/v1/users/me/shorten_urls/1/hours?from_date=2017-11-14&to_date=2017-11-14 -i -u your_login:your_password    